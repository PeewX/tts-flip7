{
  "GUID": "bd69bd",
  "Name": "Chinese_Checkers_Piece",
  "Transform": {
    "posX": 33.5600052,
    "posY": -0.259998322,
    "posZ": -36.52,
    "rotX": 0.00190076465,
    "rotY": 180,
    "rotZ": 0.000379891542,
    "scaleX": 1.6499995,
    "scaleY": 1.6499995,
    "scaleZ": 1.6499995
  },
  "Nickname": "Flex Table Control",
  "Description": "",
  "GMNotes": "",
  "AltLookAngle": {
    "x": 0,
    "y": 0,
    "z": 0
  },
  "ColorDiffuse": {
    "r": 1,
    "g": 1,
    "b": 1
  },
  "LayoutGroupSortIndex": 0,
  "Value": 0,
  "Locked": true,
  "Grid": true,
  "Snap": true,
  "IgnoreFoW": false,
  "MeasureMovement": false,
  "DragSelectable": true,
  "Autoraise": true,
  "Sticky": true,
  "Tooltip": false,
  "GridProjection": false,
  "HideWhenFaceDown": false,
  "Hands": false,
  "MaterialIndex": 1,
  "LuaScript": "tableHeightOffset = -9\r\n\r\nfunction onSave()\r\n    saved_data = JSON.encode({tid=tableImageData, cd=checkData})\r\n    --saved_data = \"\"\r\n    return saved_data\r\nend\r\n\r\nfunction onload(saved_data)\r\n    --Loads the tracking for if the game has started yet\r\n    if saved_data ~= \"\" then\r\n         local loaded_data = JSON.decode(saved_data)\r\n         tableImageData = loaded_data.tid\r\n         checkData = loaded_data.cd\r\n    else\r\n        tableImageData = {}\r\n        checkData = {move=false, scale=false}\r\n    end\r\n\r\n    --Disables interactable status of objects with GUID in list\r\n    for _, guid in ipairs(ref_noninteractable) do\r\n        local obj = getObjectFromGUID(guid)\r\n        if obj then obj.interactable = false end\r\n    end\r\n\r\n    --Establish references to table parts\r\n    obj_leg1 = getObjectFromGUID(\"afc863\")\r\n    obj_leg2 = getObjectFromGUID(\"c8edca\")\r\n    obj_leg3 = getObjectFromGUID(\"393bf7\")\r\n    obj_leg4 = getObjectFromGUID(\"12c65e\")\r\n    obj_surface = getObjectFromGUID(\"4ee1f2\")\r\n    obj_side_top = getObjectFromGUID(\"35b95f\")\r\n    obj_side_bot = getObjectFromGUID(\"f938a2\")\r\n    obj_side_lef = getObjectFromGUID(\"9f95fd\")\r\n    obj_side_rig = getObjectFromGUID(\"5af8f2\")\r\n\r\n    controlActive = false\r\n    createOpenCloseButton()\r\nend\r\n\r\n\r\n\r\n--Activation/deactivation of control panel\r\n\r\n\r\n\r\n--Activated by clicking on\r\nfunction click_toggleControl(_, color)\r\n    if permissionCheck(color) then\r\n        if not controlActive then\r\n            --Activate control panel\r\n            controlActive = true\r\n            self.clearButtons()\r\n            createOpenCloseButton()\r\n            createSurfaceInput()\r\n            createSurfaceButtons()\r\n            createScaleInput()\r\n            createScaleButtons()\r\n        else\r\n            --Deactivate control panel\r\n            controlActive = false\r\n            self.clearButtons()\r\n            self.clearInputs()\r\n            createOpenCloseButton()\r\n\r\n        end\r\n    end\r\nend\r\n\r\n\r\n\r\n\r\n--Table surface control\r\n\r\n\r\n\r\n--Changes table surface\r\nfunction click_applySurface(_, color)\r\n    if permissionCheck(color) then\r\n        updateSurface()\r\n        broadcastToAll(\"New Table Image Applied\", {0.2,0.9,0.2})\r\n    end\r\nend\r\n\r\n--Saves table surface\r\nfunction click_saveSurface(_, color)\r\n    if permissionCheck(color) then\r\n        local nickname = self.getInputs()[1].value\r\n        local url = self.getInputs()[2].value\r\n        if nickname == \"\" then\r\n            --No nickname\r\n            broadcastToAll(\"Please supply a nickname for this save.\", {0.9,0.2,0.2})\r\n        else\r\n            --Nickname exists\r\n\r\n            if findInImageDataIndex(url, nickname) == nil then\r\n                --Save doesn't exist already\r\n                table.insert(tableImageData, {url=url, name=nickname})\r\n                broadcastToAll(\"Image URL saved to memory.\", {0.2,0.9,0.2})\r\n                --Refresh buttons\r\n                self.clearButtons()\r\n                createOpenCloseButton()\r\n                createSurfaceButtons()\r\n                createScaleButtons()\r\n            else\r\n                --Save exists already\r\n                broadcastToAll(\"Memory already contains a save with this Name or URL. Delete it first.\", {0.9,0.2,0.2})\r\n            end\r\n        end\r\n    end\r\nend\r\n\r\n--Loads table surface\r\nfunction click_loadMemory(_, color, index)\r\n    if permissionCheck(color) then\r\n        self.editInput({index=0, value=tableImageData[index].name})\r\n        self.editInput({index=1, value=tableImageData[index].url})\r\n        updateSurface()\r\n        broadcastToAll(\"Table Image Loaded\", {0.2,0.9,0.2})\r\n    end\r\nend\r\n\r\n--Deletes table surface\r\nfunction click_deleteMemory(_, color, index)\r\n    if permissionCheck(color) then\r\n        table.remove(tableImageData, index)\r\n        self.clearButtons()\r\n        createOpenCloseButton()\r\n        createSurfaceButtons()\r\n        createScaleButtons()\r\n        broadcastToAll(\"Element Removed from Memory\", {0.2,0.9,0.2})\r\n    end\r\nend\r\n\r\n--Updates surface from the values in the input field\r\nfunction updateSurface()\r\n    local customInfo = obj_surface.getCustomObject()\r\n    customInfo.diffuse = self.getInputs()[2].value\r\n    obj_surface.setCustomObject(customInfo)\r\n    obj_surface = obj_surface.reload()\r\nend\r\n\r\n\r\n\r\n--Table Scale control\r\n\r\n\r\n\r\n--Applies Scale to table pieces\r\nfunction click_applyScale(_, color)\r\n    if permissionCheck(color) then\r\n        local newWidth = tonumber(self.getInputs()[3].value)\r\n        local newDepth = tonumber(self.getInputs()[4].value)\r\n        if type(newWidth) ~= \"number\" then\r\n            broadcastToAll(\"Invalid Width\", {0.9,0.2,0.2})\r\n            return\r\n        elseif type(newDepth) ~= \"number\" then\r\n            broadcastToAll(\"Invalid Depth\", {0.9,0.2,0.2})\r\n            return\r\n        elseif newWidth<0.1 or newDepth<0.1 then\r\n            broadcastToAll(\"Scale cannot go below 0.1\", {0.9,0.2,0.2})\r\n            return\r\n        elseif newWidth>12 or newDepth>12 then\r\n            broadcastToAll(\"Scale should not go over 12 (world size limitation)\", {0.9,0.2,0.2})\r\n            return\r\n        else\r\n            changeTableScale(math.abs(newWidth), math.abs(newDepth))\r\n            broadcastToAll(\"Scale applied.\", {0.2,0.9,0.2})\r\n        end\r\n    end\r\nend\r\n\r\n--Checks/unchecks move box for hands\r\nfunction click_checkMove(_, color)\r\n    if permissionCheck(color) then\r\n        local find_func = function(o) return o.click_function==\"click_checkMove\" end\r\n        if checkData.move == true then\r\n            checkData.move = false\r\n            local buttonEntry = findButton(self, find_func)\r\n            self.editButton({index=buttonEntry.index, label=\"\"})\r\n        else\r\n            checkData.move = true\r\n            local buttonEntry = findButton(self, find_func)\r\n            self.editButton({index=buttonEntry.index, label=string.char(10008)})\r\n        end\r\n    end\r\nend\r\n\r\n--Checks/unchecks scale box for hands\r\n--This button was disabled for technical reasons\r\n--[[\r\nfunction click_checkScale(_, color)\r\n    if permissionCheck(color) then\r\n        local find_func = function(o) return o.click_function==\"click_checkScale\" end\r\n        if checkData.scale == true then\r\n            checkData.scale = false\r\n            local buttonEntry = findButton(self, find_func)\r\n            self.editButton({index=buttonEntry.index, label=\"\"})\r\n        else\r\n            checkData.scale = true\r\n            local buttonEntry = findButton(self, find_func)\r\n            self.editButton({index=buttonEntry.index, label=string.char(10008)})\r\n        end\r\n    end\r\nend\r\n]]\r\n\r\n--Alters scale of elements and moves them\r\nfunction changeTableScale(width, depth)\r\n    --Scaling factors used to translate scale to position offset\r\n    local width2pos = (width-1) * 18\r\n    local depth2pos = (depth-1) * 18\r\n\r\n    --Hand zone movement\r\n    if checkData.move == true then\r\n        for _, pc in ipairs(ref_playerColor) do\r\n            if Player[pc].getHandCount() > 0 then\r\n                moveHandZone(Player[pc], width2pos, depth2pos)\r\n            end\r\n        end\r\n    end\r\n    --Hand zone scaling\r\n    --The button to enable this was disabled for technical reasons\r\n    if checkData.scale == true then\r\n        for _, pc in ipairs(ref_playerColor) do\r\n            if Player[pc].getHandCount() > 0 then\r\n                scaleHandZone(Player[pc], width, depth)\r\n            end\r\n        end\r\n    end\r\n\r\n    --Resizing table elements\r\n    obj_side_top.setScale({width, 1, 1})\r\n    obj_side_bot.setScale({width, 1, 1})\r\n    obj_side_lef.setScale({depth, 1, 1})\r\n    obj_side_rig.setScale({depth, 1, 1})\r\n    obj_surface.setScale({width, 1, depth})\r\n\r\n    --Moving table elements to accomodate new scale\r\n    obj_side_lef.setPosition({-width2pos,tableHeightOffset,0})\r\n    obj_side_rig.setPosition({ width2pos,tableHeightOffset,0})\r\n    obj_side_top.setPosition({0,tableHeightOffset, depth2pos})\r\n    obj_side_bot.setPosition({0,tableHeightOffset,-depth2pos})\r\n    obj_leg1.setPosition({-width2pos,tableHeightOffset,-depth2pos})\r\n    obj_leg2.setPosition({-width2pos,tableHeightOffset, depth2pos})\r\n    obj_leg3.setPosition({ width2pos,tableHeightOffset, depth2pos})\r\n    obj_leg4.setPosition({ width2pos,tableHeightOffset,-depth2pos})\r\n    self.setPosition(obj_leg4.positionToWorld({-22.12, 8.74,-19.16}))\r\n    --Only enabled when changing tableHeightOffset\r\n    --obj_surface.setPosition({0,tableHeightOffset,0})\r\nend\r\n\r\n--Move hand zone, p=player reference, facts are scaling factors\r\nfunction moveHandZone(p, width2pos, depth2pos)\r\n    local widthX = obj_side_rig.getPosition().x\r\n    local depthZ = obj_side_top.getPosition().z\r\n    for i=1, p.getHandCount() do\r\n        local handT = p.getHandTransform()\r\n        local pos = handT.position\r\n        local y = handT.rotation.y\r\n\r\n        if y<45 or y>320 or y>135 and y<225 then\r\n            if pos.z > 0 then\r\n                pos.z = pos.z + depth2pos - depthZ\r\n            else\r\n                pos.z = pos.z - depth2pos + depthZ\r\n            end\r\n        else\r\n            if pos.x > 0 then\r\n                pos.x = pos.x + width2pos - widthX\r\n            else\r\n                pos.x = pos.x - width2pos + widthX\r\n            end\r\n        end\r\n\r\n        --Only enabled when changing tableHeightOffset\r\n        --pos.y = tableHeightOffset + 14\r\n\r\n        handT.position = pos\r\n        p.setHandTransform(handT, i)\r\n    end\r\nend\r\n\r\n\r\n---Scales hand zones, p=player reference, facts are scaling factors\r\nfunction scaleHandZone(p, width, depth)\r\n    local widthFact = width / obj_side_top.getScale().x\r\n    local depthFact = depth / obj_side_lef.getScale().x\r\n    for i=1, p.getHandCount() do\r\n        local handT = p.getHandTransform()\r\n        local scale = handT.scale\r\n        local y = handT.rotation.y\r\n        if y<45 or y>320 or y>135 and y<225 then\r\n            scale.x = scale.x * widthFact\r\n        else\r\n            scale.x = scale.x * depthFact\r\n        end\r\n        handT.scale = scale\r\n        p.setHandTransform(handT, i)\r\n    end\r\nend\r\n\r\n\r\n\r\n--Information gathering\r\n\r\n\r\n\r\n--Checks if a color is promoted or host\r\nfunction permissionCheck(color)\r\n    if Player[color].host==true or Player[color].promoted==true then\r\n        return true\r\n    else\r\n        return false\r\n    end\r\nend\r\n\r\n--Locates a string saved within memory file\r\nfunction findInImageDataIndex(...)\r\n    for _, str in ipairs({...}) do\r\n        for i, v in ipairs(tableImageData) do\r\n            if v.url == str or v.name == str then\r\n                return i\r\n            end\r\n        end\r\n    end\r\n    return nil\r\nend\r\n\r\n--Round number (num) to the Nth decimal (dec)\r\nfunction round(num, dec)\r\n  local mult = 10^(dec or 0)\r\n  return math.floor(num * mult + 0.5) / mult\r\nend\r\n\r\n--Locates a button with a helper function\r\nfunction findButton(obj, func)\r\n    if func==nil then error(\"No func supplied to findButton\") end\r\n    for _, v in ipairs(obj.getButtons()) do\r\n        if func(v) then\r\n            return v\r\n        end\r\n    end\r\n    return nil\r\nend\r\n\r\n\r\n\r\n--Creation of buttons/inputs\r\n\r\n\r\n\r\nfunction createOpenCloseButton()\r\n    local tooltip = \"Open Table Control Panel\"\r\n    if controlActive then\r\n        tooltip = \"Close Table Control Panel\"\r\n    end\r\n    self.createButton({\r\n        click_function=\"click_toggleControl\", function_owner=self,\r\n        position={0,0,0}, rotation={-45,0,0}, height=400, width=400,\r\n        color={1,1,1,0}, tooltip=tooltip\r\n    })\r\nend\r\n\r\nfunction createSurfaceInput()\r\n    local currentURL = obj_surface.getCustomObject().diffuse\r\n    local nickname = \"\"\r\n    if findInImageDataIndex(currentURL) ~= nil then\r\n        nickname = tableImageData[findInImageDataIndex(currentURL)].name\r\n    end\r\n    self.createInput({\r\n        label=\"Nickname\", input_function=\"none\", function_owner=self,\r\n        alignment=3, position={0,0,2}, height=224, width=4000,\r\n        font_size=200, tooltip=\"Enter nickname for table image (only used for save)\",\r\n        value=nickname\r\n    })\r\n    self.createInput({\r\n        label=\"URL\", input_function=\"none\", function_owner=self,\r\n        alignment=3, position={0,0,3}, height=224, width=4000,\r\n        font_size=200, tooltip=\"Enter URL for tabletop image\",\r\n        value=currentURL\r\n    })\r\nend\r\n\r\nfunction createSurfaceButtons()\r\n    --Label\r\n    self.createButton({\r\n        label=\"Tabletop Surface Image\", click_function=\"none\",\r\n        position={0,0,1}, height=0, width=0, font_size=300, font_color={1,1,1}\r\n    })\r\n    --Functional\r\n    self.createButton({\r\n        label=\"Apply Image\\nTo Table\", click_function=\"click_applySurface\",\r\n        function_owner=self, tooltip=\"Apply URL as table image\",\r\n        position={2,0,4}, height=440, width=1400, font_size=200,\r\n    })\r\n    self.createButton({\r\n        label=\"Save Image\\nTo Memory\", click_function=\"click_saveSurface\",\r\n        function_owner=self, tooltip=\"Record URL into memory (requires nickname)\",\r\n        position={-2,0,4}, height=440, width=1400, font_size=200,\r\n    })\r\n    --Label\r\n    self.createButton({\r\n        label=\"Load From Memory\", click_function=\"none\",\r\n        position={0,0,5.5}, height=0, width=0, font_size=300, font_color={1,1,1}\r\n    })\r\n    --Saves, created dynamically from memory file\r\n    for i, memoryEntry in ipairs(tableImageData) do\r\n        --Load\r\n        local funcName = i..\"loadMemory\"\r\n        local func = function(x,y) click_loadMemory(x,y,i) end\r\n        self.setVar(funcName, func)\r\n        self.createButton({\r\n            label=memoryEntry.name, click_function=funcName,\r\n            function_owner=self, tooltip=memoryEntry.url, font_size=200,\r\n            position={-0.6,0,6.5+0.5*(i-1)}, height=240, width=3300,\r\n        })\r\n        --Delete\r\n        local funcName = i..\"deleteMemory\"\r\n        local func = function(x,y) click_deleteMemory(x,y,i) end\r\n        self.setVar(funcName, func)\r\n        self.createButton({\r\n            label=\"DELETE\", click_function=funcName,\r\n            function_owner=self, tooltip=\"\",\r\n            position={3.6,0,6.5+0.5*(i-1)}, height=240, width=600,\r\n            font_size=160, font_color={1,0,0}, color={0.8,0.8,0.8}\r\n        })\r\n    end\r\nend\r\n\r\nfunction createScaleInput()\r\n    self.createInput({\r\n        label=string.char(8644), input_function=\"none\", function_owner=self,\r\n        alignment=3, position={-8.5,0,2}, height=224, width=400,\r\n        font_size=200, tooltip=\"Table Width\",\r\n        value=round(obj_side_top.getScale().x, 1)\r\n    })\r\n    self.createInput({\r\n        label=string.char(8645), input_function=\"none\", function_owner=self,\r\n        alignment=3, position={-7.5,0,2}, height=224, width=400,\r\n        font_size=200, tooltip=\"Table Depth\",\r\n        value=round(obj_side_lef.getScale().x, 1)\r\n    })\r\nend\r\n\r\nfunction createScaleButtons()\r\n    --Labels\r\n    self.createButton({\r\n        label=\"Table Scale\", click_function=\"none\",\r\n        position={-8,0,1}, height=0, width=0, font_size=300, font_color={1,1,1}\r\n    })\r\n    self.createButton({\r\n        label=string.char(8644)..\"            \"..string.char(8645),\r\n        click_function=\"none\",\r\n        position={-8,0,2}, height=0, width=0, font_size=300, font_color={1,1,1}\r\n    })\r\n    self.createButton({\r\n        label=\"Move Hands:\", click_function=\"none\",\r\n        position={-8.3,0,3}, height=0, width=0, font_size=200, font_color={1,1,1}\r\n    })\r\n    --Disabled due to me removing the feature for technical reasons\r\n    --[[\r\n    self.createButton({\r\n        label=\"Scale Hands:\", click_function=\"none\",\r\n        position={-8.3,0,4}, height=0, width=0, font_size=200, font_color={1,1,1}\r\n    })\r\n    ]]\r\n    --Checkboxes\r\n    local label = \"\"\r\n    if checkData.move == true then label = string.char(10008) end\r\n    self.createButton({\r\n        label=label, click_function=\"click_checkMove\",\r\n        function_owner=self, tooltip=\"Check to move hands when table is rescaled\",\r\n        position={-6.8,0,3}, height=224, width=224, font_size=200,\r\n    })\r\n    --[[\r\n    local label = \"\"\r\n    if checkData.scale == true then label = string.char(10008) end\r\n    self.createButton({\r\n        label=label, click_function=\"click_checkScale\",\r\n        function_owner=self, tooltip=\"Check to scale the width of hands when table is rescaled\",\r\n        position={-6.8,0,4}, height=224, width=224, font_size=200,\r\n    })\r\n    ]]\r\n    --Apply button\r\n    self.createButton({\r\n        label=\"Apply Scale\", click_function=\"click_applyScale\",\r\n        function_owner=self, tooltip=\"Apply width/depth to table\",\r\n        position={-8,0,4}, height=440, width=1400, font_size=200,\r\n    })\r\nend\r\n\r\n\r\n\r\n\r\n\r\n--Data tables\r\n\r\n\r\n\r\n\r\nref_noninteractable = {\r\n    \"afc863\",\"c8edca\",\"393bf7\",\"12c65e\",\"f938a2\",\"9f95fd\",\"35b95f\",\r\n    \"5af8f2\",\"4ee1f2\",\"bd69bd\"\r\n}\r\n\r\nref_playerColor = {\r\n    \"White\", \"Brown\", \"Red\", \"Orange\", \"Yellow\",\r\n    \"Green\", \"Teal\", \"Blue\", \"Purple\", \"Pink\", \"Black\"\r\n}\r\n\r\n--Dummy function, absorbs unwanted triggers\r\nfunction none() end",
  "LuaScriptState": "{\"cd\":{\"move\":true,\"scale\":false},\"tid\":[{\"name\":\"Felt - Green\",\"url\":\"https://i.imgur.com/eHXDjyy.jpg\"},{\"name\":\"Felt - Red\",\"url\":\"https://i.imgur.com/DbPelDi.jpg\"},{\"name\":\"Felt - Grey\",\"url\":\"https://i.imgur.com/N0O6aqj.jpg\"}]}",
  "XmlUI": ""
}